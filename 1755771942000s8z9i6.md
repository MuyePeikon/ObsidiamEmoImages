## 伴学鸭PHP服务器环境配置及项目编译

### 1. 环境编译
#### macos 
添加homebrew的三方PHP仓库
brew tap shivammathur/php

brew install php
brew install pkg-config
brew install pcre2

pecl install igbinary
pecl install redis
pecl install swoole-4.8.13

PCRE2 配置
export CPPFLAGS="-I/opt/homebrew/opt/pcre2/include $CPPFLAGS"
export LDFLAGS="-L/opt/homebrew/opt/pcre2/lib $LDFLAGS"

安装 composer
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php -r "if (hash_file('sha384', 'composer-setup.php') === 'dac665fdc30fdd8ec78b38b9800061b4150413ff2e3b6f88543c636f7cd84f6db9189d43a81e5503cda447da73c7e5b6') { echo 'Installer verified'.PHP_EOL; } else { echo 'Installer corrupt'.PHP_EOL; unlink('composer-setup.php'); exit(1); }"
php composer-setup.php
php -r "unlink('composer-setup.php');"

mv composer.phar /usr/local/bin/composer

nginx /huanyuan 升级websocket

    location /hunyuan {
      proxy_pass http://localhost:9405;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;  # 升级 HTTP 连接为 WebSocket
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }



不需要的操作，扩展知识
brew link --overwrite --force php@8.1  # 切换到PHP 8.1，可用于多版本切换

#### centos10
使用的php 8.3,项目启动后会有很多api的废弃提醒

更新库信息
sudo dnf update -y
sudo dnf install -y epel-release
sudo dnf install -y https://rpms.remirepo.net/enterprise/remi-release-10.rpm

查看PHP的安装信息
sudo dnf module list php
启用模块
sudo dnf module enable php:remi-8.1 -y 
sudo dnf install php


sudo dnf isntall php-devel (8.0/8.1安装， pecl安装扩展需要)
sudo dnf install -y php-mysqlnd 

PHP的扩展管理工具
sudo dnf install php-pear (8.3/8.1都需要安装)
更新库信息
sudo pecl update-channels

sudo pecl install redis

sudo pecl install swoole(PHP8.1 PHP8.3)
    1.  问题: Package 'libbrotlienc', required by 'virtual:world', not found
       
        a. 解决: sudo dnf install libbrotli
            这个方法没有生效
        b. 启用 PowerTools 源（包含 Brotli 库）
           dnf config-manager --set-enabled crb
           安装 Brotli 开发包
           dnf install -y brotli-devel
        可能的原因:  Swoole 扩展通过pecl安装时需要编译源代码，因此不仅需要运行时库（libbrotli），还需要开发头文件（brotli-devel）。当仅安装libbrotli时，编译过程会因缺少头文件而失败；安装brotli-devel后，头文件和库文件齐全，编译才能成功。
sudo pecl install swoole-4.8.13    PHP 8.0时指定版本为4.8.13
    1. 问题：In file included from /var/tmp/swoole/src/protocol/socks5.cc:19:
                /var/tmp/swoole/include/swoole_proxy.h:43:5: error: 'uint8_t' does not name a type
                43 |     uint8_t state;
                    |     ^~~~~~~
                /var/tmp/swoole/include/swoole_proxy.h:20:1: note: 'uint8_t' is defined in header '<cstdint>'; this is probably fixable by adding '#include <cstdint>'
                19 | #include <string>
                +++ |+#include <cstdint>
                20 |
                /var/tmp/swoole/include/swoole_proxy.h:44:5: error: 'uint8_t' does not name a type
                44 |     uint8_t dont_handshake;
                    |     ^~~~~~~
                /var/tmp/swoole/include/swoole_proxy.h:44:5: note: 'uint8_t' is defined in header '<cstdint>'; this is probably fixable by adding '#include <cstdint>'
                /var/tmp/swoole/include/swoole_proxy.h:59:5: error: 'uint8_t' does not name a type
                59 |     uint8_t state;
                    |     ^~~~~~~
                /var/tmp/swoole/include/swoole_proxy.h:59:5: note: 'uint8_t' is defined in header '<cstdint>'; this is probably fixable by adding '#include <cstdint>'
                /var/tmp/swoole/include/swoole_proxy.h:60:5: error: 'uint8_t' does not name a type
                60 |     uint8_t version;
                    |     ^~~~~~~
                /var/tmp/swoole/include/swoole_proxy.h:60:5: note: 'uint8_t' is defined in header '<cstdint>'; this is probably fixable by adding '#include <cstdint>'
                /var/tmp/swoole/include/swoole_proxy.h:61:5: error: 'uint8_t' does not name a type
                61 |     uint8_t method;
                    |     ^~~~~~~
                /var/tmp/swoole/include/swoole_proxy.h:61:5: note: 'uint8_t' is defined in header '<cstdint>'; this is probably fixable by adding '#include <cstdint>'
                /var/tmp/swoole/include/swoole_proxy.h:62:5: error: 'uint8_t' does not name a type
                62 |     uint8_t dns_tunnel;
                    |     ^~~~~~~
                /var/tmp/swoole/include/swoole_proxy.h:62:5: note: 'uint8_t' is defined in header '<cstdint>'; this is probably fixable by adding '#include <cstdint>'
                make: *** [Makefile:375：src/protocol/socks5.lo] 错误 1
       解决：sudo dnf install -y gcc make autoconf libtool \
                php-devel php-pear re2c bison libxml2-devel \
                openssl-devel bzip2-devel libcurl-devel \
                libjpeg-devel libpng-devel libicu-devel
            sudo dnf install -y libstdc++-devel
            sudo pecl clear-cache
            sudo pecl install swoole-4.8.13
            sudo pecl install swoole-4.8.13

sudo dnf search composer
有这个源直接安装，没有这个源，官网下载安装，脚本如下：
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    php -r "if (hash_file('sha384', 'composer-setup.php') === 'dac665fdc30fdd8ec78b38b9800061b4150413ff2e3b6f88543c636f7cd84f6db9189d43a81e5503cda447da73c7e5b6') { echo 'Installer verified'.PHP_EOL; } else { echo 'Installer corrupt'.PHP_EOL; unlink('composer-setup.php'); exit(1); }"
    php composer-setup.php
    php -r "unlink('composer-setup.php');"

    编译成功后，将命令移动到PATH下
    sudo mv composer.phar /usr/local/bin/composer

composer install 
    1. 问题： 缺少PHP扩展，bcmath 和 sodium 扩展（根据你的 PHP 版本调整）
       解决： dnf install -y php-bcmath php-sodium
    2. 问题：problem 1
            - Root composer.json requires hyperf/redis ^2.2 -> satisfiable by hyperf/redis[v2.2.0-beta1, ..., 2.2.x-dev].
            - hyperf/redis[v2.2.0-beta1, ..., 2.2.x-dev] require ext-redis * -> it is missing from your system. Install or enable PHPs redis extension.
                Alternatively you can require one of these packages that provide the extension (or parts of it):
                Keep in mind that the suggestions are automated and may not be valid or safe to use
                - cultuurnet/monolog-socketio
       解决：sudo dnf install -y php-redis     


### 2. 项目配置


1. 初始化数据，导入数据sql
2. cp .env.example .env 修改mysql和redis的配置


### 3. 安装ffmpeg
1. 安装依赖包

    首先需要安装编译 FFmpeg 所需的依赖工具和库：
    sudo dnf update -y
    sudo dnf install -y epel-release
    sudo dnf groupinstall -y "Development Tools"
    sudo dnf install -y yasm nasm libtool libva-devel libvdpau-devel libxcb-devel libX11-devel libXext-devel libXfixes-devel
    

2. 安装额外依赖库

    FFmpeg 需要一些额外的媒体编码库支持
    # 安装 x264 编码库
    sudo dnf install -y https://download1.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm
    sudo dnf install -y x264-devel x265-devel libvpx-devel libmp3lame-devel opus-devel

    # 如果需要 NVENC (NVIDIA 硬件编码) 支持，安装 NVIDIA 驱动和相关库
    # sudo dnf install -y akmod-nvidia xorg-x11-drv-nvidia-cuda

3. 下载并编译 FFmpeg 6.1
    # 创建编译目录
    mkdir -p ~/ffmpeg_sources && cd ~/ffmpeg_sources

    # 下载 FFmpeg 6.1 源码
    curl -O -L https://ffmpeg.org/releases/ffmpeg-6.1.2.tar.gz
    tar xzvf ffmpeg-6.1.2tar.gz
    cd ffmpeg-6.1.2

    # 配置编译选项
    ./configure \
    --prefix="/usr/local" \
    --enable-gpl \
    --enable-version3 \
    --enable-nonfree \
    --enable-libmp3lame \
    --enable-libx264 \
    --enable-libx265 \
    --enable-libvpx \
    --enable-libopus \
    --enable-postproc \
    --enable-pthreads \
    --enable-shared \
    --enable-static \
    --disable-debug \
    --disable-doc

        问题：ERROR: libmp3lame >= 3.98.3 not found
        解决：从 RPM Fusion 仓库安装 libmp3lame-devel
            # 安装 RPM Fusion 免费仓库
            sudo dnf install -y https://download1.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm
            # 安装 libmp3lame 开发库
            sudo dnf install -y lame lame-devel

        问题：ERROR: opus not found using pkg-config
        解决：安装 opus 和 opus-devel 包， RPM Fusion 仓库提供了 opus 和 opus-devel 包，直接安装即可：    
        # 确保已安装 RPM Fusion 免费仓库（如果之前未安装）
        sudo dnf install -y https://download1.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm
        # 安装 opus 开发库
        sudo dnf install -y opus opus-devel

        问题：libvpx enabled but no supported decoders found
        解决：安装或更新 libvpx-devel
            sudo dnf install -y libvpx-devel
        
        问题：x264 not found using pkg-config
        解决：安装 x264-devel 包
        # 确保已安装 RPM Fusion 免费仓库
        sudo dnf install -y https://download1.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm
        # 安装 x264 开发库
        sudo dnf install -y x264-devel

        问题：x265 not found using pkg-config
        解决：安装 x265-devel 包
            # 确保已安装 RPM Fusion 免费仓库
            sudo dnf install -y https://download1.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm
            # 安装 x265 开发库
            sudo dnf install -y x265-devel

    # 编译和安装
    make -j$(nproc)
    sudo make install
    sudo ldconfig



4. 验证 
    ffmpeg -version

    问题：ffmpeg: error while loading shared libraries: libavdevice.so.60: cannot open shared object file: No such file or directory
    解决：更新动态链接器缓存
    # 创建或编辑动态链接器配置文件
    echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/ffmpeg.conf
    # 更新缓存
    sudo ldconfig
    原因：动态链接器无法定位这些库导致

5. 验证编译过程中缺少的依赖包的解码器是否安装成功
   
   ffmpeg -encoders | grep vpx
   ffmpeg -encoders | grep opus
   ffmpeg -encoders | grep x265
   ffmpeg -encoders | grep x264
   ffmpeg -encoders | grep mp3